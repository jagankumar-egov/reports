# DHR Backend API Specification

## Version
**API Version**: v1.0  
**Last Updated**: August 2025  
**Base URL**: `http://localhost:3004/api` (development)

---

## Table of Contents
1. [Overview](#overview)
2. [Authentication & Security](#authentication--security)
3. [Common Response Format](#common-response-format)
4. [Error Handling](#error-handling)
5. [Endpoints](#endpoints)
6. [Data Models](#data-models)
7. [Usage Examples](#usage-examples)

---

## Overview

The DHR (Digit Health Reports) Backend API provides endpoints for querying Elasticsearch indices and retrieving health data. The API is designed to support three main query interfaces:

- **Direct Query**: Execute raw Elasticsearch queries with full JSON control
- **Auto Query**: URL parameter-driven query execution for sharing and embedding
- **Query Builder**: Field mapping discovery for visual query construction

---

## Authentication & Security

### Index Access Control
- API enforces strict index access control via `ALLOWED_HEALTH_INDEXES` environment variable
- Only pre-configured indices are accessible
- All requests validate index access before execution

### Request Headers
```http
Content-Type: application/json
X-Request-ID: <auto-generated> # Added automatically for tracking
```

### Environment Configuration
```bash
ELASTICSEARCH_HOST=http://localhost:9200
ELASTICSEARCH_USERNAME=<username>
ELASTICSEARCH_PASSWORD=<password>
ALLOWED_HEALTH_INDEXES=project-index-v1,project-task-index-v1,household-index-v1,stock-index-v1
CORS_ORIGIN=http://localhost:3000
PORT=3004
NODE_ENV=development
```

---

## Common Response Format

All API responses follow a consistent structure:

### Success Response
```json
{
  "success": true,
  "data": <response_data>,
  "meta": {
    "operationId": "abc123def",
    "totalTime": "150ms",
    "timestamp": "2025-08-24T11:30:00.000Z",
    "...additional_metadata"
  }
}
```

### Error Response
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable error message",
    "details": "Additional error context (optional)"
  }
}
```

---

## Error Handling

### Common Error Codes

| Code | HTTP Status | Description |
|------|------------|-------------|
| `MISSING_INDEX` | 400 | Index parameter is required |
| `MISSING_QUERY` | 400 | Query parameter is required |
| `INVALID_FROM` | 400 | Invalid from parameter (must be â‰¥ 0) |
| `INVALID_SIZE` | 400 | Invalid size parameter (must be 1-1000) |
| `INVALID_JSON` | 400 | Invalid JSON query format |
| `ACCESS_DENIED` | 403 | Access denied to requested index |
| `INDEX_NOT_FOUND` | 404 | Requested index does not exist |
| `MAPPING_FETCH_ERROR` | 500 | Failed to retrieve index mapping |
| `ELASTICSEARCH_ERROR` | 500 | Elasticsearch query execution failed |
| `MISSING_NAME` | 400 | Query name is required for saved queries |
| `INVALID_QUERY_TYPE` | 400 | Query type must be direct, visual, or auto |
| `MISSING_TARGET_INDEX` | 400 | Target index is required for saved queries |
| `MISSING_QUERY_DATA` | 400 | Query data is required for saved queries |
| `QUERY_NOT_FOUND` | 404 | Saved query not found |
| `QUERY_CREATE_ERROR` | 500 | Failed to create saved query |
| `QUERY_UPDATE_ERROR` | 500 | Failed to update saved query |
| `QUERY_DELETE_ERROR` | 500 | Failed to delete saved query |
| `QUERY_LIST_ERROR` | 500 | Failed to list saved queries |
| `QUERY_EXECUTE_ERROR` | 500 | Failed to execute saved query |

### Error Response Examples

#### Index Access Denied
```json
{
  "success": false,
  "error": {
    "code": "ACCESS_DENIED",
    "message": "Access denied to index: unauthorized-index"
  }
}
```

#### Invalid Query JSON
```json
{
  "success": false,
  "error": {
    "code": "INVALID_JSON",
    "message": "Invalid JSON query format",
    "details": "Unexpected token } in JSON at position 15"
  }
}
```

---

## Endpoints

### 1. Saved Queries Management

#### Create Saved Query
**Endpoint**: `POST /saved-queries`

Creates a new saved query that can be reused across different query interfaces.

##### Request Body
```json
{
  "name": "Sample Project Query",
  "description": "Query to find all active projects in Mozambique",
  "queryType": "direct",
  "targetIndex": "project-index-v1",
  "queryData": {
    "rawQuery": {
      "query": {
        "bool": {
          "must": [
            { "term": { "status.keyword": "active" } },
            { "term": { "Data.boundaryHierarchy.country.keyword": "Mozambique" } }
          ]
        }
      },
      "size": 20
    },
    "from": 0,
    "size": 20,
    "_source": ["id", "name", "status", "Data.boundaryHierarchy"]
  },
  "tags": ["projects", "mozambique", "active"]
}
```

##### Response
```json
{
  "success": true,
  "data": {
    "id": "sq_abc123def456",
    "name": "Sample Project Query",
    "description": "Query to find all active projects in Mozambique",
    "queryType": "direct",
    "targetIndex": "project-index-v1",
    "queryData": {
      "rawQuery": { /* ... */ },
      "from": 0,
      "size": 20,
      "_source": ["id", "name", "status", "Data.boundaryHierarchy"]
    },
    "metadata": {
      "createdAt": "2025-08-24T12:39:01.479Z",
      "updatedAt": "2025-08-24T12:39:01.479Z",
      "tags": ["projects", "mozambique", "active"],
      "executionCount": 0
    }
  },
  "meta": {
    "operationId": "sq_create_xyz789",
    "totalTime": "245ms",
    "timestamp": "2025-08-24T12:39:01.724Z"
  }
}
```

#### Get All Saved Queries
**Endpoint**: `GET /saved-queries`

Retrieves saved queries with optional filtering and pagination.

##### Query Parameters
- `queryType` (optional): Filter by query type (`direct`, `visual`, `auto`)
- `targetIndex` (optional): Filter by target index name
- `tags` (optional): Comma-separated list of tags to filter by
- `limit` (optional): Maximum number of results (default: 100, max: 1000)
- `offset` (optional): Number of results to skip (default: 0)

##### Response
```json
{
  "success": true,
  "data": {
    "queries": [
      {
        "id": "sq_abc123def456",
        "name": "Sample Project Query",
        "description": "Query to find all active projects in Mozambique",
        "queryType": "direct",
        "targetIndex": "project-index-v1",
        "queryData": { /* ... */ },
        "metadata": {
          "createdAt": "2025-08-24T12:39:01.479Z",
          "updatedAt": "2025-08-24T12:39:01.479Z",
          "tags": ["projects", "mozambique", "active"],
          "executionCount": 5,
          "lastExecutedAt": "2025-08-24T15:22:15.123Z"
        }
      }
    ],
    "pagination": {
      "total": 1,
      "limit": 100,
      "offset": 0,
      "hasMore": false
    }
  },
  "meta": {
    "operationId": "sq_list_abc456",
    "totalTime": "76ms",
    "timestamp": "2025-08-24T12:45:22.156Z"
  }
}
```

#### Get Specific Saved Query
**Endpoint**: `GET /saved-queries/{queryId}`

Retrieves a specific saved query by ID.

##### Response
```json
{
  "success": true,
  "data": {
    "id": "sq_abc123def456",
    "name": "Sample Project Query",
    /* ... full saved query object ... */
  },
  "meta": {
    "operationId": "sq_get_def789",
    "totalTime": "45ms",
    "timestamp": "2025-08-24T12:46:08.892Z"
  }
}
```

#### Update Saved Query
**Endpoint**: `PUT /saved-queries/{queryId}`

Updates an existing saved query.

##### Request Body
```json
{
  "name": "Updated Project Query",
  "description": "Updated description",
  "queryData": {
    "rawQuery": { /* updated query */ }
  },
  "tags": ["projects", "mozambique", "updated"]
}
```

#### Delete Saved Query
**Endpoint**: `DELETE /saved-queries/{queryId}`

Deletes a saved query permanently.

##### Response
```json
{
  "success": true,
  "data": {
    "deleted": true,
    "queryId": "sq_abc123def456"
  },
  "meta": {
    "operationId": "sq_delete_ghi012",
    "totalTime": "89ms",
    "timestamp": "2025-08-24T12:47:33.445Z"
  }
}
```

#### Execute Saved Query
**Endpoint**: `POST /saved-queries/{queryId}/execute`

Retrieves saved query data for execution and increments the execution count.

##### Response
```json
{
  "success": true,
  "data": {
    "query": {
      "id": "sq_abc123def456",
      /* ... full saved query object with updated executionCount ... */
    },
    "message": "Query data retrieved successfully. Execute using the appropriate query interface."
  },
  "meta": {
    "operationId": "sq_execute_jkl345",
    "totalTime": "72ms",
    "timestamp": "2025-08-24T12:48:15.778Z"
  }
}
```

### 2. Execute Direct Elasticsearch Query

Execute raw Elasticsearch queries with full control over query DSL.

**Endpoint**: `POST /direct-query`

#### Request Body
```json
{
  "index": "project-index-v1",
  "query": {
    "query": {
      "bool": {
        "must": [
          { "match": { "status": "active" } }
        ]
      }
    },
    "size": 10,
    "from": 0
  },
  "from": 0,          // Optional: Override query from parameter
  "size": 10,         // Optional: Override query size parameter
  "_source": ["field1", "field2"]  // Optional: Field filtering
}
```

#### Query Parameters
- None (all parameters in request body)

#### Response
```json
{
  "success": true,
  "data": {
    "took": 15,
    "timed_out": false,
    "_shards": {
      "total": 1,
      "successful": 1,
      "skipped": 0,
      "failed": 0
    },
    "hits": {
      "total": {
        "value": 1000,
        "relation": "eq"
      },
      "max_score": 1.5,
      "hits": [
        {
          "_index": "project-index-v1",
          "_type": "_doc",
          "_id": "doc123",
          "_score": 1.5,
          "_source": {
            "status": "active",
            "name": "Sample Project",
            "created": "2025-01-15T10:30:00Z"
          }
        }
      ]
    },
    "aggregations": {
      "status_count": {
        "buckets": [
          {"key": "active", "doc_count": 750},
          {"key": "inactive", "doc_count": 250}
        ]
      }
    }
  },
  "meta": {
    "operationId": "dq_abc123",
    "totalTime": "145ms",
    "searchTime": "120ms",
    "index": "project-index-v1",
    "from": 0,
    "size": 10,
    "timestamp": "2025-08-24T11:30:00.000Z"
  }
}
```

---

### 2. Get Available Indexes

Retrieve list of accessible Elasticsearch indexes.

**Endpoint**: `GET /direct-query/indexes`

#### Query Parameters
- None

#### Response
```json
{
  "success": true,
  "data": [
    "project-index-v1",
    "project-task-index-v1", 
    "household-index-v1",
    "stock-index-v1"
  ],
  "meta": {
    "operationId": "idx_xyz789",
    "totalTime": "5ms",
    "count": 4,
    "timestamp": "2025-08-24T11:30:00.000Z"
  }
}
```

---

### 3. Get Index Field Mapping

Retrieve field mapping information for visual query builder.

**Endpoint**: `GET /direct-query/indexes/{indexName}/mapping`

#### Path Parameters
- `indexName` (string): Name of the Elasticsearch index

#### Query Parameters
- None

#### Response
```json
{
  "success": true,
  "data": {
    "project-task-index-v1": {
      "mappings": {
        "properties": {
          "Data": {
            "properties": {
              "@timestamp": {
                "type": "date"
              },
              "administrativeArea": {
                "type": "text",
                "fields": {
                  "keyword": {
                    "type": "keyword",
                    "ignore_above": 256
                  }
                }
              },
              "fullName": {
                "type": "text",
                "fields": {
                  "keyword": {
                    "type": "keyword",
                    "ignore_above": 256
                  }
                }
              },
              "memberCount": {
                "type": "long"
              },
              "geoPoint": {
                "type": "float"
              },
              "projectId": {
                "type": "text",
                "fields": {
                  "keyword": {
                    "type": "keyword",
                    "ignore_above": 256
                  }
                }
              }
            }
          },
          "id": {
            "type": "keyword"
          },
          "timestamp": {
            "type": "date"
          }
        }
      }
    }
  },
  "meta": {
    "operationId": "map_def456",
    "totalTime": "25ms",
    "mappingTime": "20ms",
    "indexName": "project-task-index-v1",
    "timestamp": "2025-08-24T11:30:00.000Z"
  }
}
```

---

## Data Models

### SavedQuery
```typescript
interface SavedQuery {
  id: string;                    // Unique identifier
  name: string;                  // Human-readable query name
  description?: string;          // Optional description
  queryType: 'direct' | 'visual' | 'auto'; // Query interface type
  targetIndex: string;           // Target Elasticsearch index
  queryData: {
    // For direct queries
    rawQuery?: any;              // Raw Elasticsearch query DSL
    from?: number;               // Starting document offset
    size?: number;               // Number of documents to return
    _source?: string[] | boolean; // Field filtering
    
    // For visual queries
    visualFields?: Array<{
      field: string;             // Field name
      operator: string;          // Query operator (term, match, range, etc.)
      value: any;               // Query value
      type: string;             // Field type (text, keyword, number, date)
    }>;
    
    // For auto queries
    urlParams?: Record<string, string>; // URL parameter mappings
  };
  metadata: {
    createdAt: string;           // ISO timestamp of creation
    updatedAt: string;           // ISO timestamp of last update
    createdBy?: string;          // Optional creator identifier
    tags?: string[];             // Optional tags for organization
    executionCount?: number;     // Number of times executed
    lastExecutedAt?: string;     // ISO timestamp of last execution
  };
}
```

### CreateSavedQueryRequest
```typescript
interface CreateSavedQueryRequest {
  name: string;                  // Required: Query name
  description?: string;          // Optional: Query description
  queryType: 'direct' | 'visual' | 'auto'; // Required: Query type
  targetIndex: string;           // Required: Target index
  queryData: SavedQuery['queryData']; // Required: Query configuration
  tags?: string[];               // Optional: Organization tags
}
```

### UpdateSavedQueryRequest
```typescript
interface UpdateSavedQueryRequest {
  name?: string;                 // Optional: Updated name
  description?: string;          // Optional: Updated description
  queryData?: SavedQuery['queryData']; // Optional: Updated query data
  tags?: string[];               // Optional: Updated tags
}
```

### SavedQueriesListResponse
```typescript
interface SavedQueriesListResponse {
  queries: SavedQuery[];         // Array of saved queries
  pagination: {
    total: number;               // Total number of matching queries
    limit: number;               // Request limit parameter
    offset: number;              // Request offset parameter
    hasMore: boolean;            // Whether more results are available
  };
}
```

### DirectQueryRequest
```typescript
interface DirectQueryRequest {
  index: string;           // Required: Elasticsearch index name
  query: any;             // Required: Elasticsearch query DSL
  from?: number;          // Optional: Starting document offset (0-based)
  size?: number;          // Optional: Number of documents to return (1-1000)
  _source?: string[] | boolean; // Optional: Field filtering
}
```

### DirectQueryResponse
```typescript
interface DirectQueryResponse {
  took: number;           // Query execution time in milliseconds
  timed_out: boolean;     // Whether the query timed out
  _shards: {
    total: number;        // Total number of shards queried
    successful: number;   // Number of successful shards
    skipped: number;      // Number of skipped shards
    failed: number;       // Number of failed shards
  };
  hits: {
    total: {
      value: number;      // Total number of matching documents
      relation: "eq" | "gte"; // Relation of total count
    };
    max_score: number;    // Highest score among returned documents
    hits: Array<{
      _index: string;     // Index name
      _type: string;      // Document type
      _id: string;        // Document ID
      _score: number;     // Document relevance score
      _source: any;       // Document source data
    }>;
  };
  aggregations?: any;     // Optional: Aggregation results
}
```

### FieldMapping
```typescript
interface FieldMapping {
  [indexName: string]: {
    mappings: {
      properties: {
        [fieldName: string]: {
          type: string;           // Field type (text, keyword, long, date, etc.)
          fields?: {              // Multi-field mappings
            [subField: string]: {
              type: string;
              ignore_above?: number;
            };
          };
          properties?: FieldMapping; // Nested object properties
        };
      };
    };
  };
}
```

---

## Usage Examples

### 1. Basic Search Query
```bash
curl -X POST http://localhost:3004/api/direct-query \
  -H "Content-Type: application/json" \
  -d '{
    "index": "project-index-v1",
    "query": {
      "query": {
        "match_all": {}
      },
      "size": 5
    }
  }'
```

### 2. Filtered Search with Aggregations
```bash
curl -X POST http://localhost:3004/api/direct-query \
  -H "Content-Type: application/json" \
  -d '{
    "index": "project-task-index-v1",
    "query": {
      "query": {
        "bool": {
          "must": [
            { "match": { "Data.taskType": "delivery" } }
          ]
        }
      },
      "aggs": {
        "status_breakdown": {
          "terms": { "field": "status.keyword" }
        }
      },
      "size": 10
    }
  }'
```

### 3. Field-Filtered Query
```bash
curl -X POST http://localhost:3004/api/direct-query \
  -H "Content-Type: application/json" \
  -d '{
    "index": "household-index-v1",
    "query": {
      "query": { "match_all": {} },
      "size": 20
    },
    "_source": ["id", "Data.fullName", "Data.administrativeArea"]
  }'
```

### 4. Get Available Indexes
```bash
curl http://localhost:3004/api/direct-query/indexes
```

### 5. Get Index Mapping
```bash
curl http://localhost:3004/api/direct-query/indexes/project-index-v1/mapping
```

### 6. Create a Saved Direct Query
```bash
curl -X POST http://localhost:3004/api/saved-queries \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Active Projects in Mozambique",
    "description": "Find all active projects in Mozambique with project details",
    "queryType": "direct",
    "targetIndex": "project-index-v1",
    "queryData": {
      "rawQuery": {
        "query": {
          "bool": {
            "must": [
              { "term": { "status.keyword": "active" } },
              { "term": { "Data.boundaryHierarchy.country.keyword": "Mozambique" } }
            ]
          }
        },
        "size": 50
      },
      "from": 0,
      "size": 50,
      "_source": ["id", "Data.name", "status", "Data.boundaryHierarchy"]
    },
    "tags": ["projects", "mozambique", "active", "production"]
  }'
```

### 7. Create a Saved Visual Query
```bash
curl -X POST http://localhost:3004/api/saved-queries \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Household Tasks by Status",
    "description": "Visual query to filter household tasks by completion status",
    "queryType": "visual",
    "targetIndex": "project-task-index-v1",
    "queryData": {
      "visualFields": [
        {
          "field": "Data.taskType",
          "operator": "term",
          "value": "household_survey",
          "type": "keyword"
        },
        {
          "field": "status",
          "operator": "terms",
          "value": ["completed", "in_progress"],
          "type": "keyword"
        }
      ],
      "rawQuery": {
        "query": {
          "bool": {
            "must": [
              { "term": { "Data.taskType.keyword": "household_survey" } },
              { "terms": { "status.keyword": ["completed", "in_progress"] } }
            ]
          }
        }
      }
    },
    "tags": ["household", "tasks", "status", "survey"]
  }'
```

### 8. List Saved Queries with Filtering
```bash
# Get all direct queries for a specific index
curl "http://localhost:3004/api/saved-queries?queryType=direct&targetIndex=project-index-v1&limit=20"

# Get queries with specific tags
curl "http://localhost:3004/api/saved-queries?tags=projects,mozambique&limit=10"

# Get all visual queries
curl "http://localhost:3004/api/saved-queries?queryType=visual"
```

### 9. Execute a Saved Query
```bash
curl -X POST http://localhost:3004/api/saved-queries/sq_abc123def456/execute
```

### 10. Update a Saved Query
```bash
curl -X PUT http://localhost:3004/api/saved-queries/sq_abc123def456 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Active Projects Query",
    "description": "Updated description with more details",
    "tags": ["projects", "mozambique", "active", "updated", "v2"]
  }'
```

### 11. Delete a Saved Query
```bash
curl -X DELETE http://localhost:3004/api/saved-queries/sq_abc123def456
```

---

## Rate Limiting & Performance

### Request Limits
- **Query Size**: Maximum 1000 documents per request
- **Timeout**: 30 seconds per request
- **Concurrent Requests**: No explicit limit (depends on Elasticsearch cluster)

### Performance Optimization
- Use `_source` filtering to reduce payload size
- Implement client-side pagination for large result sets
- Consider aggregations for summary data instead of retrieving all documents

### Monitoring
- All requests include `operationId` for tracing
- Response times tracked in `meta.totalTime` and `meta.searchTime`
- Structured logging for debugging and monitoring

---

## Security Considerations

1. **Index Access Control**: Only pre-configured indexes are accessible
2. **Query Validation**: All queries validated before execution
3. **Parameter Sanitization**: Input parameters sanitized and validated
4. **Error Information**: Error responses avoid exposing internal system details
5. **CORS Configuration**: Properly configured for allowed origins

---

## Development & Testing

### Health Check
```bash
curl http://localhost:3004/api/health
```

### Testing with Different Environments
- **Development**: `http://localhost:3004/api`
- **Staging**: Update base URL as configured
- **Production**: Update base URL as configured

### Debugging
- Check server logs for detailed error information
- Use `operationId` from response `meta` for tracing requests
- Monitor Elasticsearch cluster health and performance

---

*Last updated: August 2025*