# DHR Backend API Specification

## Version
**API Version**: v1.0  
**Last Updated**: August 2025  
**Base URL**: `http://localhost:3004/api` (development)

---

## Table of Contents
1. [Overview](#overview)
2. [Authentication & Security](#authentication--security)
3. [Common Response Format](#common-response-format)
4. [Error Handling](#error-handling)
5. [Endpoints](#endpoints)
6. [Data Models](#data-models)
7. [Usage Examples](#usage-examples)

---

## Overview

The DHR (Digit Health Reports) Backend API provides endpoints for querying Elasticsearch indices and retrieving health data. The API is designed to support three main query interfaces:

- **Direct Query**: Execute raw Elasticsearch queries with full JSON control
- **Auto Query**: URL parameter-driven query execution for sharing and embedding
- **Query Builder**: Field mapping discovery for visual query construction

---

## Authentication & Security

### Index Access Control
- API enforces strict index access control via `ALLOWED_HEALTH_INDEXES` environment variable
- Only pre-configured indices are accessible
- All requests validate index access before execution

### Request Headers
```http
Content-Type: application/json
X-Request-ID: <auto-generated> # Added automatically for tracking
```

### Environment Configuration
```bash
ELASTICSEARCH_HOST=http://localhost:9200
ELASTICSEARCH_USERNAME=<username>
ELASTICSEARCH_PASSWORD=<password>
ALLOWED_HEALTH_INDEXES=project-index-v1,project-task-index-v1,household-index-v1,stock-index-v1
CORS_ORIGIN=http://localhost:3000
PORT=3004
NODE_ENV=development
```

---

## Common Response Format

All API responses follow a consistent structure:

### Success Response
```json
{
  "success": true,
  "data": <response_data>,
  "meta": {
    "operationId": "abc123def",
    "totalTime": "150ms",
    "timestamp": "2025-08-24T11:30:00.000Z",
    "...additional_metadata"
  }
}
```

### Error Response
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable error message",
    "details": "Additional error context (optional)"
  }
}
```

---

## Error Handling

### Common Error Codes

| Code | HTTP Status | Description |
|------|------------|-------------|
| `MISSING_INDEX` | 400 | Index parameter is required |
| `MISSING_QUERY` | 400 | Query parameter is required |
| `INVALID_FROM` | 400 | Invalid from parameter (must be â‰¥ 0) |
| `INVALID_SIZE` | 400 | Invalid size parameter (must be 1-1000) |
| `INVALID_JSON` | 400 | Invalid JSON query format |
| `ACCESS_DENIED` | 403 | Access denied to requested index |
| `INDEX_NOT_FOUND` | 404 | Requested index does not exist |
| `MAPPING_FETCH_ERROR` | 500 | Failed to retrieve index mapping |
| `ELASTICSEARCH_ERROR` | 500 | Elasticsearch query execution failed |

### Error Response Examples

#### Index Access Denied
```json
{
  "success": false,
  "error": {
    "code": "ACCESS_DENIED",
    "message": "Access denied to index: unauthorized-index"
  }
}
```

#### Invalid Query JSON
```json
{
  "success": false,
  "error": {
    "code": "INVALID_JSON",
    "message": "Invalid JSON query format",
    "details": "Unexpected token } in JSON at position 15"
  }
}
```

---

## Endpoints

### 1. Execute Direct Elasticsearch Query

Execute raw Elasticsearch queries with full control over query DSL.

**Endpoint**: `POST /direct-query`

#### Request Body
```json
{
  "index": "project-index-v1",
  "query": {
    "query": {
      "bool": {
        "must": [
          { "match": { "status": "active" } }
        ]
      }
    },
    "size": 10,
    "from": 0
  },
  "from": 0,          // Optional: Override query from parameter
  "size": 10,         // Optional: Override query size parameter
  "_source": ["field1", "field2"]  // Optional: Field filtering
}
```

#### Query Parameters
- None (all parameters in request body)

#### Response
```json
{
  "success": true,
  "data": {
    "took": 15,
    "timed_out": false,
    "_shards": {
      "total": 1,
      "successful": 1,
      "skipped": 0,
      "failed": 0
    },
    "hits": {
      "total": {
        "value": 1000,
        "relation": "eq"
      },
      "max_score": 1.5,
      "hits": [
        {
          "_index": "project-index-v1",
          "_type": "_doc",
          "_id": "doc123",
          "_score": 1.5,
          "_source": {
            "status": "active",
            "name": "Sample Project",
            "created": "2025-01-15T10:30:00Z"
          }
        }
      ]
    },
    "aggregations": {
      "status_count": {
        "buckets": [
          {"key": "active", "doc_count": 750},
          {"key": "inactive", "doc_count": 250}
        ]
      }
    }
  },
  "meta": {
    "operationId": "dq_abc123",
    "totalTime": "145ms",
    "searchTime": "120ms",
    "index": "project-index-v1",
    "from": 0,
    "size": 10,
    "timestamp": "2025-08-24T11:30:00.000Z"
  }
}
```

---

### 2. Get Available Indexes

Retrieve list of accessible Elasticsearch indexes.

**Endpoint**: `GET /direct-query/indexes`

#### Query Parameters
- None

#### Response
```json
{
  "success": true,
  "data": [
    "project-index-v1",
    "project-task-index-v1", 
    "household-index-v1",
    "stock-index-v1"
  ],
  "meta": {
    "operationId": "idx_xyz789",
    "totalTime": "5ms",
    "count": 4,
    "timestamp": "2025-08-24T11:30:00.000Z"
  }
}
```

---

### 3. Get Index Field Mapping

Retrieve field mapping information for visual query builder.

**Endpoint**: `GET /direct-query/indexes/{indexName}/mapping`

#### Path Parameters
- `indexName` (string): Name of the Elasticsearch index

#### Query Parameters
- None

#### Response
```json
{
  "success": true,
  "data": {
    "project-task-index-v1": {
      "mappings": {
        "properties": {
          "Data": {
            "properties": {
              "@timestamp": {
                "type": "date"
              },
              "administrativeArea": {
                "type": "text",
                "fields": {
                  "keyword": {
                    "type": "keyword",
                    "ignore_above": 256
                  }
                }
              },
              "fullName": {
                "type": "text",
                "fields": {
                  "keyword": {
                    "type": "keyword",
                    "ignore_above": 256
                  }
                }
              },
              "memberCount": {
                "type": "long"
              },
              "geoPoint": {
                "type": "float"
              },
              "projectId": {
                "type": "text",
                "fields": {
                  "keyword": {
                    "type": "keyword",
                    "ignore_above": 256
                  }
                }
              }
            }
          },
          "id": {
            "type": "keyword"
          },
          "timestamp": {
            "type": "date"
          }
        }
      }
    }
  },
  "meta": {
    "operationId": "map_def456",
    "totalTime": "25ms",
    "mappingTime": "20ms",
    "indexName": "project-task-index-v1",
    "timestamp": "2025-08-24T11:30:00.000Z"
  }
}
```

---

## Data Models

### DirectQueryRequest
```typescript
interface DirectQueryRequest {
  index: string;           // Required: Elasticsearch index name
  query: any;             // Required: Elasticsearch query DSL
  from?: number;          // Optional: Starting document offset (0-based)
  size?: number;          // Optional: Number of documents to return (1-1000)
  _source?: string[] | boolean; // Optional: Field filtering
}
```

### DirectQueryResponse
```typescript
interface DirectQueryResponse {
  took: number;           // Query execution time in milliseconds
  timed_out: boolean;     // Whether the query timed out
  _shards: {
    total: number;        // Total number of shards queried
    successful: number;   // Number of successful shards
    skipped: number;      // Number of skipped shards
    failed: number;       // Number of failed shards
  };
  hits: {
    total: {
      value: number;      // Total number of matching documents
      relation: "eq" | "gte"; // Relation of total count
    };
    max_score: number;    // Highest score among returned documents
    hits: Array<{
      _index: string;     // Index name
      _type: string;      // Document type
      _id: string;        // Document ID
      _score: number;     // Document relevance score
      _source: any;       // Document source data
    }>;
  };
  aggregations?: any;     // Optional: Aggregation results
}
```

### FieldMapping
```typescript
interface FieldMapping {
  [indexName: string]: {
    mappings: {
      properties: {
        [fieldName: string]: {
          type: string;           // Field type (text, keyword, long, date, etc.)
          fields?: {              // Multi-field mappings
            [subField: string]: {
              type: string;
              ignore_above?: number;
            };
          };
          properties?: FieldMapping; // Nested object properties
        };
      };
    };
  };
}
```

---

## Usage Examples

### 1. Basic Search Query
```bash
curl -X POST http://localhost:3004/api/direct-query \
  -H "Content-Type: application/json" \
  -d '{
    "index": "project-index-v1",
    "query": {
      "query": {
        "match_all": {}
      },
      "size": 5
    }
  }'
```

### 2. Filtered Search with Aggregations
```bash
curl -X POST http://localhost:3004/api/direct-query \
  -H "Content-Type: application/json" \
  -d '{
    "index": "project-task-index-v1",
    "query": {
      "query": {
        "bool": {
          "must": [
            { "match": { "Data.taskType": "delivery" } }
          ]
        }
      },
      "aggs": {
        "status_breakdown": {
          "terms": { "field": "status.keyword" }
        }
      },
      "size": 10
    }
  }'
```

### 3. Field-Filtered Query
```bash
curl -X POST http://localhost:3004/api/direct-query \
  -H "Content-Type: application/json" \
  -d '{
    "index": "household-index-v1",
    "query": {
      "query": { "match_all": {} },
      "size": 20
    },
    "_source": ["id", "Data.fullName", "Data.administrativeArea"]
  }'
```

### 4. Get Available Indexes
```bash
curl http://localhost:3004/api/direct-query/indexes
```

### 5. Get Index Mapping
```bash
curl http://localhost:3004/api/direct-query/indexes/project-index-v1/mapping
```

---

## Rate Limiting & Performance

### Request Limits
- **Query Size**: Maximum 1000 documents per request
- **Timeout**: 30 seconds per request
- **Concurrent Requests**: No explicit limit (depends on Elasticsearch cluster)

### Performance Optimization
- Use `_source` filtering to reduce payload size
- Implement client-side pagination for large result sets
- Consider aggregations for summary data instead of retrieving all documents

### Monitoring
- All requests include `operationId` for tracing
- Response times tracked in `meta.totalTime` and `meta.searchTime`
- Structured logging for debugging and monitoring

---

## Security Considerations

1. **Index Access Control**: Only pre-configured indexes are accessible
2. **Query Validation**: All queries validated before execution
3. **Parameter Sanitization**: Input parameters sanitized and validated
4. **Error Information**: Error responses avoid exposing internal system details
5. **CORS Configuration**: Properly configured for allowed origins

---

## Development & Testing

### Health Check
```bash
curl http://localhost:3004/api/health
```

### Testing with Different Environments
- **Development**: `http://localhost:3004/api`
- **Staging**: Update base URL as configured
- **Production**: Update base URL as configured

### Debugging
- Check server logs for detailed error information
- Use `operationId` from response `meta` for tracing requests
- Monitor Elasticsearch cluster health and performance

---

*Last updated: August 2025*